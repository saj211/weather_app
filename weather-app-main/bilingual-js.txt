//the following content is the js file of the bilingula version of this code


let lang = localStorage.getItem("lang") || "en";

const texts = {
  en: {
    greeting: "How's the sky looking today?",
    search: "Search",
    loadingCity: "Loading city..."
  },
  fa: {
    greeting: "آسمان امروز چطوره؟",
    search: "جستجو",
    loadingCity: "در حال بارگذاری..."
  }
};

const langBtn = document.querySelector(".langBtn");

langBtn.onclick = () => {
  lang = lang === "en" ? "fa" : "en";
  localStorage.setItem("lang", lang);
  applyLanguage();
};

//to show the any text letter by letter
function showTextLetterByLetter(el, text, delay) {
  const letters = text.split("");
  el.textContent = "";

  letters.forEach((ch, i) => {
    setTimeout(() => {
      el.textContent += ch;
    }, i * delay);
  });
}


function showPersianDate() {
  const now = new Date();
  const options = {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
    calendar: "persian"
  };
  document.getElementById("date").textContent =
    now.toLocaleDateString("fa-IR", options);
}

function showEnglishDate() {
  const now = new Date();
  const options = {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric"
  };
  document.getElementById("date").textContent =
    now.toLocaleDateString("en-US", options);
}

function applyLanguage() {
    if(lang==="fa"){
        document.body.classList.add("rtl");
        translateToFa();
        showPersianDate();
        showTextLetterByLetter(document.querySelector(".greeting"), texts.fa.greeting, 50);
    }else{
        document.body.classList.remove("rtl");
        translateToEn();
        showEnglishDate();
        showTextLetterByLetter(document.querySelector(".greeting"), texts.en.greeting, 50);
    }
};


// get lat lon
function getLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject("Geolocation not supported");
    } else {
      navigator.geolocation.getCurrentPosition(resolve, reject);
    }
  });
}

// get city
async function getCity(lat, lon) {
  const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=${lang}`;
//big data cloud api for location
  const res = await fetch(url);
  const data = await res.json();

 return `${data.city || data.locality || data.principalSubdivision || "Unknown City"}, ${data.countryName}`;

}

// get weather
async function getWeather(lat, lon) {
  const url =
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,weathercode`;
//open mateo api for weather
  const res = await fetch(url);
  const data = await res.json();
  return data.current;
}

function getWeatherIcon(code){
    if (code===0 || code===1) return "assets/images/icon-sunny.webp";
    else if(code===2) return "assets/images/icon-partly-cloudy.webp";
    else if(code===3) return "assets/images/icon-fog.webp";
    else if(code < 50 && code>= 40) return "assets/images/icon-fog.webp";
    else if(code>=51 && code<= 67) return "assets/images/icon-rain.webp";
    else if(code>=71 && code<= 77) return "assets/images/icon-snow.webp";
    else if (code>=95) return "assets/images/icon-storm.webp";
    return "assets/images/icon-sunny.webp";
}

// init
async function initWeather() {
  try {
    const position = await getLocation();

    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    const weather =await getWeather(lat, lon);

    document.getElementById("city").textContent = texts[lang].loadingCity; 
    const city = await getCity(lat, lon);
    document.getElementById("city").textContent = city;

    document.getElementById("temp").textContent =
      `${weather.temperature_2m}°C`;
    const icon= document.getElementById("weatherIcon");
    icon.src = getWeatherIcon(weather.weathercode);
  } catch (err) {
    console.log(err);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  applyLanguage();
  initWeather();
});


function translateToFa(){
    document.querySelector(".greeting").textContent= texts.fa.greeting;
    document.querySelector(".search-btn").textContent= texts.fa.search;
};

function translateToEn(){
    document.querySelector(".greeting").textContent= texts.en.greeting;
    document.querySelector(".search-btn").textContent= texts.en.search;
};

const btn = document.getElementById("unitbtn");
const menu = document.getElementById("unitmenu");

    btn.onclick = () => {
      menu.classList.toggle("open");
    };

    const state = {
      temp: "f",
      wind:"kmh",
      rain: "mm"
    };

    document.querySelectorAll(".item").forEach(item =>
    {item.addEventListener("click", () => {
const type = item.dataset.type;
const value = item.dataset.value;


    state[type]=value;
    updateCheck(type);
    applyFilters();
      });
  });

  function updateCheck (type){

document.querySelectorAll(`.item[data-type="${type}"]`)
  .forEach(i => {
    i.querySelector(".check").innerHTML = "";
  });


document.querySelector(`.item[data-type="${type}"][data-value="${state[type]}"] .check`)
  .innerHTML = '<img src="assets/images/icon-checkmark.svg" class="check-icon">';

  }

  function applyFilters(){
    console.log("current units: ", state);
  }

  document.addEventListener("click", e => {
    if(!menu.contains(e.target) && !btn.contains(e.target)){
      menu.classList.remove("open");
    }
  });






